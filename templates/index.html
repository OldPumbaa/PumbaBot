<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PumbaBot: Главная</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/static/notifications.js"></script>
</head>
<body class="p-4">
    <div class="mx-auto max-w-screen-2xl px-2">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-4">
            <h1 class="text-xl sm:text-2xl font-bold">Тикеты техподдержки</h1>
            <div class="flex flex-wrap items-center gap-2 text-sm sm:text-base">
                <span class="text-xs sm:text-sm text-gray-600">Вы вошли как: {{ employee.login }} <span id="employee-ratings" class="text-sm text-gray-600">Загрузка рейтингов...</span></span>
                <a href="/admin/employees" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded flex items-center" aria-label="Управление сотрудниками">
                    <i class="fas fa-users-between-lines"></i>
                </a>
                <a href="/settings" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded flex items-center" aria-label="Настройки">
                    <i class="fas fa-gears"></i>
                </a>
                <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded flex items-center" aria-label="Выйти">
                    <i class="fas fa-door-open"></i>
                </a>
            </div>
        </div>

        <div class="mb-4">
            <form action="/search" method="get" class="flex items-center">
                <input type="text" autocomplete="off" name="query" placeholder="Поиск по тикетам..." class="border p-2 rounded-l-md w-full max-w-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-500 text-white p-2 rounded-r-md hover:bg-blue-600 flex items-center" aria-label="Найти">
                    <i class="fas fa-magnifying-glass"></i>
                </button>
            </form>
            <a href="/search" class="mt-2 inline-block text-blue-500 underline hover:text-blue-700">Расширенный поиск</a>
        </div>

        <div class="mb-4">
            <label class="inline-flex items-center">
                <input type="checkbox" id="is-holiday" name="is_holiday" {% if settings.is_holiday == '1' %}checked{% endif %} class="form-checkbox h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-600">Выходной</span>
            </label>
        </div>

        <div id="ticketsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto">
            {% for ticket in tickets %}
            <div class="border p-4 rounded-lg shadow-sm bg-white hover:shadow-md transition flex flex-col h-full" data-ticket-id="{{ ticket.id }}">
                
                <div class="flex-grow">
                    <div class="flex items-center gap-2 mb-1">
                        <p class="font-bold m-0">Тикет #{{ ticket.id }}</p>
                        <span data-role="issue-type"
                            class="inline-flex text-xs px-1.5 py-0.5 rounded text-white whitespace-nowrap
                            {% if ticket.issue_type == 'tech' %}bg-red-500{% elif ticket.issue_type == 'org' %}bg-blue-500{% elif ticket.issue_type == 'ins' %}bg-green-500{% else %}bg-gray-500{% endif %}">
                            {{ ticket.issue_type | default('n/a') }}
                        </span>
                    </div>

                    <p>Пользователь: {{ ticket.login }}</p>
                    <p data-role="assigned">Ответственный: {{ ticket.assigned_login or 'Не назначен' }}</p>
                    <div class="last-message text-sm text-gray-600 mt-2">
                        {% if ticket.last_message or ticket.attachments %}
                            <p class="text-sm text-gray-700 line-clamp-2">
                                Последнее сообщение:
                                {% if not ticket.last_message and ticket.attachments %}
                                    {% set att = ticket.attachments[0] %}
                                    {% if att.file_type == 'image' %}
                                        [изображение]
                                    {% else %}
                                        [файл]
                                    {% endif %}
                                {% else %}
                                    <span class="last-msg-text break-words">{{ ticket.last_message }}</span>
                                {% endif %}
                                <span class="text-xs text-gray-400">({{ ticket.last_message_timestamp }})</span>
                            </p>
                        {% else %}
                            <p class="text-xs text-gray-400 italic">Сообщений пока нет</p>
                        {% endif %}
                    </div>
                </div>

                <a href="/ticket/{{ ticket.id }}" 
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded inline-flex items-center mt-2 self-start">
                Открыть
                </a>
            </div>

            {% endfor %}
        </div>

        <script>
            function shortenFilename(filename) {
                if (!filename) return 'unknown';
                if (filename.length > 20) {
                    return filename.substring(0, 17) + '...';
                }
                return filename;
            }

            const socket = io('{{ BASE_URL }}', { transports: ['websocket', 'polling'] });

            socket.on('connect', () => {
                console.log('Подключено к SocketIO');
            });

            socket.on('connect_error', (error) => {
                console.error('Ошибка подключения к SocketIO:', error);
            });

            socket.on("update_tickets", (data) => {
                console.log('Обновление тикета:', data);

                const issueType = data.issue_type || 'n/a';
                const issueTypeClass =
                    issueType === 'tech' ? 'bg-red-500' :
                    issueType === 'org'  ? 'bg-blue-500' :
                    issueType === 'ins'  ? 'bg-green-500' : 'bg-gray-500';

                let lastMsgText = (data.last_message && data.last_message.trim()) 
                    ? trimText(data.last_message) 
                    : '';

                if ((!lastMsgText || lastMsgText.length === 0) &&
                    Array.isArray(data.attachments) && data.attachments.length > 0) {
                    const att = data.attachments[0];
                    lastMsgText = att.file_type === 'image' ? '[изображение]' : '[файл]';
                }

                const ts = data.last_message_timestamp || data.timestamp || '';
                const lastMessageHtml = lastMsgText
                    ? `<p class="text-sm text-gray-700 line-clamp-2">Последнее сообщение: ${escapeHtml(lastMsgText)} 
                        <span class="text-xs text-gray-400">(${escapeHtml(ts)})</span>
                    </p>`
                    : `<p class="text-xs text-gray-400 italic">Сообщений пока нет</p>`;

                const ticketDiv = document.querySelector(`[data-ticket-id="${data.ticket_id}"]`);
                if (ticketDiv) {
                    // Update existing ticket
                    ticketDiv.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold m-0">Тикет #${escapeHtml(data.ticket_id)}</p>
                                <span data-role="issue-type" 
                                    class="inline-flex text-xs px-1.5 py-0.5 rounded text-white whitespace-nowrap ${issueTypeClass}">
                                    ${escapeHtml(issueType)}
                                </span>
                            </div>

                            <p>Пользователь: ${escapeHtml(data.login || 'Unknown')}</p>
                            <p data-role="assigned">Ответственный: ${escapeHtml(data.assigned_login || 'Не назначен')}</p>

                            <div class="last-message text-sm text-gray-600 mt-2">
                                ${lastMessageHtml}
                            </div>
                        </div>

                        <a href="/ticket/${escapeHtml(data.ticket_id)}" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded inline-flex items-center mt-2 self-start">
                        Открыть
                        </a>
                    `;
                } else {
                    // Add new ticket
                    const newTicketDiv = document.createElement("div");
                    newTicketDiv.className = "border p-4 mb-2 rounded-lg shadow-sm bg-white hover:shadow-md transition flex flex-col h-full";
                    newTicketDiv.setAttribute("data-ticket-id", data.ticket_id);

                    newTicketDiv.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold m-0">Тикет #${escapeHtml(data.ticket_id)}</p>
                                <span data-role="issue-type" 
                                    class="inline-flex text-xs px-1.5 py-0.5 rounded text-white whitespace-nowrap ${issueTypeClass}">
                                    ${escapeHtml(issueType)}
                                </span>
                            </div>

                            <p>Пользователь: ${escapeHtml(data.login || 'Unknown')}</p>
                            <p data-role="assigned">Ответственный: ${escapeHtml(data.assigned_login || 'Не назначен')}</p>

                            <div class="last-message text-sm text-gray-600 mt-2">
                                ${lastMessageHtml}
                            </div>
                        </div>

                        <a href="/ticket/${escapeHtml(data.ticket_id)}" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded inline-flex items-center mt-2 self-start">
                        Открыть
                        </a>
                    `;
                    document.getElementById("ticketsList").prepend(newTicketDiv);
                }
                if (!data.assigned_login) {
                    startTitleFlashing('🗣️ТИКЕТ🗣️');
                }
            });



            socket.on("ticket_closed", (data) => {
                console.log('Тикет закрыт:', data);
                const ticketDiv = document.querySelector(`[data-ticket-id="${data.ticket_id}"]`);
                if (ticketDiv) {
                    ticketDiv.remove();
                }
            });

            socket.on("ticket_assigned", (data) => {
            const ticketDiv = document.querySelector(`[data-ticket-id="${data.ticket_id}"]`);
            if (ticketDiv) {
                const assignedP = ticketDiv.querySelector('[data-role="assigned"]');
                if (assignedP) {
                assignedP.textContent = `Ответственный: ${data.assigned_login || 'Не назначен'}`;
                }
            }
            });


            socket.on("issue_type_updated", (data) => {
            const ticketDiv = document.querySelector(`[data-ticket-id="${data.ticket_id}"]`);
            if (ticketDiv) {
                const typeSpan = ticketDiv.querySelector('[data-role="issue-type"]');
                if (typeSpan) {
                typeSpan.className = `inline-flex text-xs px-1.5 py-0.5 rounded text-white whitespace-nowrap ${
                    data.issue_type === 'tech' ? 'bg-red-500' :
                    data.issue_type === 'org'  ? 'bg-blue-500' :
                    data.issue_type === 'ins'  ? 'bg-green-500' : 'bg-gray-500'
                }`;
                typeSpan.textContent = data.issue_type || 'n/a';
                }
            }
            });


            socket.on("new_message", (data) => {
                if (!data.ticket_id || !data.timestamp) return;
                const ticketDiv = document.querySelector(`[data-ticket-id="${data.ticket_id}"]`);
                if (!ticketDiv) return;

                const messageDiv = ticketDiv.querySelector('.last-message');
                if (!messageDiv) return;

                const isHistoryMessage = data.text && data.text.startsWith('[Ticket #]');
                if (isHistoryMessage) return;

                let lastMsgText = data.text ? trimText(data.text) : '';
                if ((!lastMsgText || lastMsgText.trim() === '') && data.attachments && data.attachments.length > 0) {
                    const att = data.attachments[0];
                    lastMsgText = att.file_type === 'image' ? '[изображение]' : '[файл]';
                }

                messageDiv.innerHTML = `
                    <p class="text-sm text-gray-700 line-clamp-2">
                        Последнее сообщение: 
                        <span class="last-msg-text break-words">${escapeHtml(lastMsgText)}</span>
                        <span class="text-xs text-gray-400">(${escapeHtml(data.timestamp)})</span>
                    </p>
                `;

                if (!data.is_from_bot) {
                    playNotificationSound();
                    startTitleFlashing('✉️СООБЩЕНИЕ✉️');
                }
            });



            socket.on("employee_rated", (data) => {
                console.log('Employee rated:', data);
                if (data.employee_id === {{ employee.telegram_id }}) {
                    const ratingsSpan = document.getElementById('employee-ratings');
                    if (ratingsSpan) {
                        ratingsSpan.innerHTML = `👍 ${data.thumbs_up} | 👎 ${data.thumbs_down}`;
                    }
                }
            });

            async function fetchEmployeeRatings() {
                const ratingsSpan = document.getElementById('employee-ratings');
                if (!ratingsSpan) {
                    console.error('Элемент employee-ratings не найден');
                    return;
                }
                try {
                    const response = await fetch(`/employee/{{ employee.telegram_id }}/ratings`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('Получены рейтинги:', data);
                    if (data.status === 'ok') {
                        ratingsSpan.innerHTML = `👍 ${data.thumbs_up} | 👎 ${data.thumbs_down}`;
                    } else {
                        ratingsSpan.innerHTML = 'Нет рейтингов';
                    }
                } catch (error) {
                    console.error('Ошибка загрузки рейтингов:', error);
                    ratingsSpan.innerHTML = 'Ошибка загрузки рейтингов';
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                fetchEmployeeRatings();

                document.querySelectorAll('.last-msg-text').forEach(el => {
                        el.textContent = trimText(el.textContent);
                    });

                document.getElementById('is-holiday').addEventListener('change', async (e) => {
                    const isHoliday = e.target.checked ? '1' : '0';
                    try {
                        const response = await fetch('/update_holiday', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_holiday: isHoliday })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        console.log('Статус праздника обновлен:', isHoliday);
                    } catch (error) {
                        console.error('Ошибка обновления статуса праздника:', error);
                        alert('Ошибка при обновлении статуса праздника');
                        e.target.checked = !e.target.checked; // Откатить изменение
                    }
                });

                checkUnassignedOnLoad();
            });

            function escapeHtml(str) {
                return String(str ?? '')
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#039;');
            }

            function trimText(text, maxLength = 100) {
                if (!text) return '';
                text = text.trim();
                return text.length > maxLength ? text.substring(0, maxLength) + '…' : text;
            }

            function checkUnassignedOnLoad() {
                let unassignedCount = 0;
                document.querySelectorAll('[data-role="assigned"]').forEach(el => {
                    if (el.textContent.trim() === 'Ответственный: Не назначен') {
                        unassignedCount++;
                    }
                });
                if (unassignedCount > 0) {
                    startTitleFlashing('🗣️ТИКЕТ🗣️');
                }
            }
        </script>
    </div>
</body>
</html>